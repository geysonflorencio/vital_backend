// index.js - Servidor principal refatorado
require('dotenv').config();

const { createServer } = require('./config/server');
const apiRoutes = require('./routes');
const { errorHandler, notFoundHandler } = require('./middleware/errorHandler');
const { debugLogger } = require('./middleware/logger');

// Verificar variÃ¡veis de ambiente obrigatÃ³rias
const requiredEnvVars = ['SUPABASE_URL', 'SUPABASE_SERVICE_ROLE_KEY'];
const missingEnvVars = requiredEnvVars.filter(varName => !process.env[varName]);

if (missingEnvVars.length > 0) {
  console.error('âŒ VariÃ¡veis de ambiente obrigatÃ³rias nÃ£o configuradas:', missingEnvVars);
  process.exit(1);
}

// Criar servidor
const { app, authLimiter } = createServer();

// Rota raiz - Landing page da API
app.get('/', (req, res) => {
  // Se hÃ¡ parÃ¢metros de query relacionados a auth, provavelmente Ã© um redirecionamento incorreto
  if (req.query.token || req.query.email || req.url.includes('type=')) {
    const frontendUrl = process.env.FRONTEND_URL || 'https://vital-deploy.vercel.app';
    const redirectUrl = `${frontendUrl}/definir-senha.html${req.url.includes('?') ? req.url.substring(req.url.indexOf('?')) : ''}`;
    
    console.log('ğŸ”„ Redirecionamento automÃ¡tico da raiz para:', redirectUrl);
    return res.redirect(302, redirectUrl);
  }

  res.json({
    message: 'ğŸš€ VITAL API - Sistema de Triagem Hospitalar',
    status: 'online',
    version: '2.0.0',
    timestamp: new Date().toISOString(),
    endpoints: {
      health: '/api/health',
      auth: '/api/cadastrar-usuario',
      solicitacoes: '/api/solicitacoes'
    },
    documentation: 'https://vital-deploy.onrender.com/api',
    note: 'Se vocÃª estÃ¡ tentando definir uma senha, acesse: https://vital-deploy.vercel.app/definir-senha.html'
  });
});

// Rota de emergÃªncia para redirecionamento de senhas
app.get('/definir-senha', (req, res) => {
  // Redirecionar para o frontend correto (nova pÃ¡gina)
  const frontendUrl = process.env.FRONTEND_URL || 'https://vital-deploy.vercel.app';
  const redirectUrl = `${frontendUrl}/cadastro-senha.html${req.url.includes('?') ? req.url.substring(req.url.indexOf('?')) : ''}`;
  
  console.log('ğŸ”„ Redirecionamento de emergÃªncia:', redirectUrl);
  res.redirect(302, redirectUrl);
});

// Rota adicional para capturar /api/definir-senha-inicial via GET
app.get('/api/definir-senha-inicial', (req, res) => {
  // Redirecionar para o frontend correto (nova pÃ¡gina)
  const frontendUrl = process.env.FRONTEND_URL || 'https://vital-deploy.vercel.app';
  const redirectUrl = `${frontendUrl}/cadastro-senha.html${req.url.includes('?') ? req.url.substring(req.url.indexOf('?')) : ''}`;
  
  console.log('ğŸ”„ Redirecionamento API definir-senha-inicial:', redirectUrl);
  res.redirect(302, redirectUrl);
});

// Rotas da API
app.use('/api', apiRoutes);

// Rotas legadas (compatibilidade com cÃ³digo antigo)
const authRoutes = require('./routes/auth');
app.use('/api', authRoutes); // MantÃ©m rotas diretas como /api/cadastrar-usuario

// Middleware de erro 404
app.use(notFoundHandler);

// Middleware de tratamento de erros
app.use(errorHandler);

// ConfiguraÃ§Ã£o do servidor
const PORT = process.env.PORT || 3001;

// Iniciar servidor
app.listen(PORT, () => {
  console.log(`ğŸš€ Servidor VITAL iniciado`, {
    port: PORT,
    environment: process.env.NODE_ENV || 'development',
    timestamp: new Date().toISOString()
  });

  // Log das rotas disponÃ­veis
  console.log('ğŸ“‹ Rotas disponÃ­veis', {
    routes: [
      `GET http://localhost:${PORT}/api/health`,
      `POST http://localhost:${PORT}/api/cadastrar-usuario`,
      `POST http://localhost:${PORT}/api/definir-senha-inicial`,
      `GET http://localhost:${PORT}/api/usuarios`,
      `DELETE http://localhost:${PORT}/api/excluir-usuario`,
      `POST http://localhost:${PORT}/api/solicitacoes`,
      `GET http://localhost:${PORT}/api/solicitacoes`
    ]
  });
});

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('ğŸ›‘ Servidor recebeu SIGTERM, encerrando graciosamente...');
  process.exit(0);
});

process.on('SIGINT', () => {
  console.log('ğŸ›‘ Servidor recebeu SIGINT, encerrando graciosamente...');
  process.exit(0);
});

// Capturar erros nÃ£o tratados
process.on('uncaughtException', (error) => {
  console.error('âŒ Erro nÃ£o capturado', {
    error: error.message,
    stack: error.stack
  });
  process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('âŒ Promise rejeitada nÃ£o tratada', {
    reason: reason,
    promise: promise
  });
  process.exit(1);
});
